@using Cpnucleo.WebApi.Client
@using Cpnucleo.WebApi.Client.Models
@inject ISnackbar Snackbar
@inject WebApiClient ApiClient

<EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator/>    
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-3 mb-n1"/>
                Add Organization
            </MudText>
        </TitleContent>
        <DialogContent>
            <MudTextField Label="Name" Required="true" RequiredError="Name is required!" @bind-Value="_model.Name" />
            <MudTextField Label="Description" Required="true" RequiredError="Description is required!" @bind-Value="_model.Description" Lines="3" />
        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Cancel</MudButton>
            <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary" Disabled="@_isSaving">
                @if (_isSaving)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                    <MudText Class="ms-2">Saving...</MudText>
                }
                else
                {
                    <MudText>Confirm</MudText>
                }
            </MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private readonly WebApiEndpointsOrganizationCreateOrganizationRequest _model = new()
    {
        Id = Guid.NewGuid().ToString(),
        Name = "",
        Description = ""
    };

    private bool _isSaving;

    private void Cancel() => MudDialog?.Cancel();
    
    private async Task OnValidSubmit(EditContext context)
    {
        _isSaving = true;
        try
        {
            // Send value to Api
            var response = await ApiClient.Api.Organization.PostAsync(_model);
            
            if (response?.Organization != null)
            {
                Snackbar.Clear();
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
                Snackbar.Add("Organization Added Successfully", Severity.Success, c => c.SnackbarVariant = Variant.Outlined);
                MudDialog?.Close(DialogResult.Ok(response.Organization));
            }
            else
            {
                Snackbar.Clear();
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
                Snackbar.Add("Failed to add organization", Severity.Error, c => c.SnackbarVariant = Variant.Outlined);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Clear();
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add($"Error adding organization: {ex.Message}", Severity.Error, c => c.SnackbarVariant = Variant.Outlined);
        }
        finally
        {
            _isSaving = false;
        }
    }
}