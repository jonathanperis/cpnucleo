@page "/organizations"
@using Cpnucleo.WebApi.Client
@using Cpnucleo.WebApi.Client.Models
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime Js
@inject WebApiClient ApiClient

<PageTitle>Organizations</PageTitle>

<Breadcrumb Items="_items" />

<MudButton StartIcon="@Icons.Material.Filled.Add" Color="Color.Success" Class="add-item-btn pa-2 ma-0 ml-4" OnClick="@AddItem">Add Item</MudButton>
<MudButton StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" Class="remove-item-btn pa-2 ma-0 ml-4" OnClick="@RemoveItem">Remove Item</MudButton>

<MudDataGrid T="WebApiCommonDtosOrganizationDto" MultiSelection Items="@_organizations" SortMode="SortMode.Multiple" Filterable QuickFilter="@QuickFilter"
             EditMode="DataGridEditMode.Form" Hideable RowClick="@RowClicked" RowContextMenuClick="RowRightClicked" 
             SelectedItemsChanged="@SelectedItemsChanged" Class="pa-4 ma-4" Virtualize HorizontalScrollbar
             EditTrigger="DataGridEditTrigger.Manual" Loading="_loading" FixedHeader Height="30rem" Elevation="1">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Organizations</MudText>
        <MudSpacer/>
        <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0">
        </MudTextField>
    </ToolBarContent>
    <Columns>
        <SelectColumn T="WebApiCommonDtosOrganizationDto" />
        <PropertyColumn Property="x => x.Id" Title="Id" Sortable="false" Filterable="false" />
        <PropertyColumn Property="x => x.Name" Title="Name" />
        <PropertyColumn Property="x => x.Description" Title="Description" />
        <PropertyColumn Property="x => x.CreatedAt" Title="Created At" Format="yyyy-MM-dd HH:mm:ss" />
        <TemplateColumn CellClass="d-flex justify-end">
            <CellTemplate>
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="() => EditItem(context.Item)" />
            </CellTemplate>
        </TemplateColumn>   
    </Columns>
    <PagerContent>
        <MudDataGridPager T="WebApiCommonDtosOrganizationDto" PageSizeOptions="new[] {10, 25, 50, 100}" />
    </PagerContent>
</MudDataGrid>
<MudMenu PositionAtCursor="true" @ref="_contextMenu" id="_contextMenu">
    @* <MudMenuItem Icon="@Icons.Material.Filled.FileCopy" OnClick="@CopyCell"> *@
    @*     Copy cell to Clipboard *@
    @* </MudMenuItem> *@
    <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" OnClick="@CopyLine">
        Copy line to Clipboard
    </MudMenuItem>
    <MudMenuItem Icon="@Icons.Material.Filled.CopyAll" OnClick="@CopySelected">
        Copy selected lines to Clipboard
    </MudMenuItem>
</MudMenu>

@code {
    private readonly ObservableCollection<WebApiCommonDtosOrganizationDto> _organizations = [];
    private HashSet<WebApiCommonDtosOrganizationDto> _selectedItems = [];
    
    private string? _searchString;
    private bool _loading;

    private WebApiCommonDtosOrganizationDto? _contextRow;
    private MudMenu _contextMenu = null!;    
    
    // quick filter - filter globally across multiple columns with the same input
    private Func<WebApiCommonDtosOrganizationDto, bool> QuickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name != null && x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (x.Description != null && x.Description.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return x.Id != null && x.Id.Contains(_searchString, StringComparison.OrdinalIgnoreCase);
    };

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        try
        {
            // Fetch organizations from the API
            var response = await ApiClient.Api.Organizations.GetAsync(config =>
            {
                config.QueryParameters.Pagination = "{\"PageNumber\":1,\"PageSize\":25,\"SortColumn\":\"Name\",\"SortOrder\":\"ASC\"}";
            });

            if (response?.Result?.Data != null)
            {
                foreach (var org in response.Result.Data)
                {
                    if (org != null)
                    {
                        _organizations.Add(org);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Clear();
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add($"Error loading organizations: {ex.Message}", Severity.Error, c => c.SnackbarVariant = Variant.Outlined);
        }
        finally
        {
            _loading = false;
        }
    }

    // events
    void RowClicked(DataGridRowClickEventArgs<WebApiCommonDtosOrganizationDto> args)
    {
        // you can handle single row click events here if needed
    }

    async Task RowRightClicked(DataGridRowClickEventArgs<WebApiCommonDtosOrganizationDto> args)
    {
        _contextRow = args.Item;
        await _contextMenu.OpenMenuAsync(args.MouseEventArgs);
    }

    void SelectedItemsChanged(HashSet<WebApiCommonDtosOrganizationDto> items)
    {
        _selectedItems = items;
    }
    
    // private async Task CopyCell()
    // {
    //     if (_contextRow is null) return;
    //     
    //     // For the demo, we copy the 'Summary' property of the selected cell.
    //     var cellContent = _contextRow.Summary ?? string.Empty;
    //     await Js.InvokeVoidAsync("navigator.clipboard.writeText", cellContent);
    //     
    //     Snackbar.Clear();
    //     Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
    //     Snackbar.Add("Cell copied to Clipboard.", Severity.Success, c => c.SnackbarVariant = Variant.Outlined);
    // }    
    
    private async Task CopyLine()
    {
        if (_contextRow is null) return;
        
        // Create a string with all properties of the current row separated by semicolons.
        var lineContent = $"{_contextRow.Id};{_contextRow.Name};{_contextRow.Description};{_contextRow.CreatedAt}";
        await Js.InvokeVoidAsync("navigator.clipboard.writeText", lineContent);
        
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        Snackbar.Add("Line copied to Clipboard.", Severity.Success, c => c.SnackbarVariant = Variant.Outlined);
    }        
    
    private async Task CopySelected()
    {
        if (_contextRow is null || !_selectedItems.Any())
        {
            Snackbar.Clear();
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("No Selected lines to copy to Clipboard.", Severity.Info, c => c.SnackbarVariant = Variant.Outlined);

            return;
        }
        
        // Copy each selected row as a line with semicolon separated values
        var selectedLines = _selectedItems.Select(row => 
            $"{row.Id};{row.Name};{row.Description};{row.CreatedAt}");
        var allLines = string.Join(Environment.NewLine, selectedLines);
        await Js.InvokeVoidAsync("navigator.clipboard.writeText", allLines);
        
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        Snackbar.Add("Selected lines copied to Clipboard.", Severity.Success, c => c.SnackbarVariant = Variant.Outlined);
    }        
    
    async Task AddItem()
    {
        var dialog = await DialogService.ShowAsync<AddOrganization>("Add Organization", new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var item = result.Data.As<WebApiCommonDtosOrganizationDto>()!;
            _organizations.Add(item);
        }        
    }
    
    async Task EditItem(WebApiCommonDtosOrganizationDto item)
    {
        var parameters = new DialogParameters<EditOrganization> { { x => x.Item, item } };

        var dialog = await DialogService.ShowAsync<EditOrganization>("Edit Organization", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            var editedItem = result.Data.As<WebApiCommonDtosOrganizationDto>()!;
            var index = _organizations.IndexOf(item);
            if (index != -1)
            {
                _organizations[index] = editedItem;
            }
        }
    }

    async Task RemoveItem()
    {
        if (_selectedItems.Any())
        {
            var organizationIds = _selectedItems.Where(x => x.Id != null).Select(x => x.Id!).ToList();
            var parameters = new DialogParameters<RemoveOrganization> { { x => x.OrganizationIds, organizationIds } };
            
            var dialog = await DialogService.ShowAsync<RemoveOrganization>("Remove Organization", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true, BackgroundClass = "blurry-dialog" });
            var result = await dialog.Result;

            if (result is { Canceled: false })
            {
                foreach (var item in _selectedItems.ToList())
                {
                    _organizations.Remove(item);
                }
                _selectedItems.Clear();
            }
        }
        else
        {
            Snackbar.Clear();
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            Snackbar.Add("No Items selected to be removed.", Severity.Info, c => c.SnackbarVariant = Variant.Outlined);
        }
    }
    
    private readonly List<BreadcrumbItem> _items =
    [
        new("Home", href: "#", icon: Icons.Material.Filled.Home),
        new("Organizations", href: null, disabled: true)
    ];
}